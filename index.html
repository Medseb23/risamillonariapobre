<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Detector de Risa</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 50px; }
    #resultado { font-size: 2em; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Detector de Risa</h1>
  <button id="iniciar">Iniciar</button>
  <div id="resultado">Esperando...</div>

  <script>
    const boton = document.getElementById('iniciar');
    const resultado = document.getElementById('resultado');

    boton.onclick = async () => {
      boton.disabled = true;
      resultado.textContent = 'Escuchando...';

      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const source = audioContext.createMediaStreamSource(stream);
      const analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
      const buffer = new Float32Array(analyser.fftSize);

      function autoCorrelacion(buf, sampleRate) {
        let SIZE = buf.length;
        let rms = 0;
        for (let i = 0; i < SIZE; i++) {
          let val = buf[i];
          rms += val * val;
        }
        rms = Math.sqrt(rms / SIZE);
        if (rms < 0.01) return -1;

        let r1 = 0, r2 = SIZE - 1, thres = 0.2;
        for (let i = 0; i < SIZE / 2; i++) {
          if (Math.abs(buf[i]) < thres) { r1 = i; break; }
        }
        for (let i = 1; i < SIZE / 2; i++) {
          if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
        }

        buf = buf.slice(r1, r2);
        SIZE = buf.length;

        let c = new Array(SIZE).fill(0);
        for (let i = 0; i < SIZE; i++) {
          for (let j = 0; j < SIZE - i; j++) {
            c[i] = c[i] + buf[j] * buf[j + i];
          }
        }

        let d = 0; while (c[d] > c[d + 1]) d++;
        let maxval = -1, maxpos = -1;
        for (let i = d; i < SIZE; i++) {
          if (c[i] > maxval) {
            maxval = c[i];
            maxpos = i;
          }
        }
        let T0 = maxpos;

        return sampleRate / T0;
      }

      let frecuencias = [];
      const duracion = 5000; // 5 segundos
      const intervalo = 100; // cada 100 ms

      const intervaloID = setInterval(() => {
        analyser.getFloatTimeDomainData(buffer);
        let pitch = autoCorrelacion(buffer, audioContext.sampleRate);
        if (pitch !== -1) {
          frecuencias.push(pitch);
        }
      }, intervalo);

      setTimeout(() => {
        clearInterval(intervaloID);
        if (frecuencias.length === 0) {
          resultado.textContent = 'ðŸ˜¶ Sin risa detectada';
          boton.disabled = false;
          return;
        }
        const suma = frecuencias.reduce((a, b) => a + b, 0);
        const promedio = suma / frecuencias.length;
        if (promedio < 150) {
          resultado.textContent = 'ðŸ’° Millonario';
        } else {
          resultado.textContent = 'ðŸ’¸ Pobre';
        }
        boton.disabled = false;
      }, duracion);
    };
  </script>
</body>
</html>
